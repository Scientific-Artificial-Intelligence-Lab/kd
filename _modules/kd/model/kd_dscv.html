<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kd.model.kd_dscv &#8212; KD 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=a66d8bb5" />
    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">KD</a></h1>



<p class="blurb">Knowledge Discovery Documentation</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Scientific-Artificial-Intelligence-Lab&repo=kd&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pde_backends.html">PDE Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viz.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for kd.model.kd_dscv</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Deep Reinforcement Learning for PDE Discovery.</span>

<span class="sd">This module implements a deep reinforcement learning approach for discovering</span>
<span class="sd">governing equations of PDEs. It supports both regular grid data and sparse</span>
<span class="sd">sampling, and can be combined with Physics-Informed Neural Networks (PINN).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">commentjson</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.task</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.dso.prior</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_prior</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.program</span><span class="w"> </span><span class="kn">import</span> <span class="n">Program</span><span class="p">,</span><span class="n">from_str_tokens</span><span class="p">,</span><span class="n">from_tokens</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.state_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_state_manager</span> <span class="k">as</span> <span class="n">manager_make_state_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.pinn</span><span class="w"> </span><span class="kn">import</span> <span class="n">PINN_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_merge_dicts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.discover.searcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">Searcher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..data</span><span class="w"> </span><span class="kn">import</span> <span class="n">SparseData</span><span class="p">,</span> <span class="n">RegularData</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>


<div class="viewcode-block" id="BaseRL">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.BaseRL">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseRL</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for reinforcement learning based models.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="BaseRL.__init__">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.BaseRL.__init__">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BaseRL.fit">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.BaseRL.fit">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model to data.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="BaseRL.predict">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.BaseRL.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make predictions.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>

    
<div class="viewcode-block" id="KD_DSCV">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KD_DSCV</span><span class="p">(</span><span class="n">BaseRL</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deep Reinforcement Learning model for PDE discovery.</span>
<span class="sd">    </span>
<span class="sd">    This class implements a deep RL approach to discover governing equations</span>
<span class="sd">    of PDEs. It uses a controller to generate candidate equations and a</span>
<span class="sd">    searcher to evaluate them.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        n_iterations (int): Number of training iterations.</span>
<span class="sd">        n_samples_per_batch (int): Number of samples per batch.</span>
<span class="sd">        operator (list): List of allowed operators.</span>
<span class="sd">        out_path (str): Path for output files.</span>
<span class="sd">        dataset: Dataset object.</span>
<span class="sd">        seed (int): Random seed.</span>
<span class="sd">        core_num (int): Number of CPU cores to use.</span>
<span class="sd">        config: Configuration dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">_parameter</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    
<div class="viewcode-block" id="KD_DSCV.__init__">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">n_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">n_samples_per_batch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">binary_operators</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">unary_operators</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;./log/&#39;</span><span class="p">,</span>
        <span class="n">core_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">config_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize KD_DSCV model.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            n_iterations (int): Number of training iterations.</span>
<span class="sd">            n_samples_per_batch (int): Number of samples per batch.</span>
<span class="sd">            binary_operators (list): List of binary operators.</span>
<span class="sd">            unary_operators (list): List of unary operators.</span>
<span class="sd">            out_path (str): Path for output files.</span>
<span class="sd">            core_num (int): Number of CPU cores to use.</span>
<span class="sd">            config_out: Optional output configuration.</span>
<span class="sd">            seed (int): Random seed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples_per_batch</span> <span class="o">=</span> <span class="n">n_samples_per_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">binary_operators</span> <span class="o">+</span> <span class="n">unary_operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">out_path</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_num</span> <span class="o">=</span> <span class="n">core_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config_file</span> <span class="o">=</span> <span class="s2">&quot;./discover/config/config_pde.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config_out</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.setup">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup model components.</span>
<span class="sd">        </span>
<span class="sd">        Initializes:</span>
<span class="sd">            - Program cache</span>
<span class="sd">            - Task</span>
<span class="sd">            - Prior</span>
<span class="sd">            - State manager</span>
<span class="sd">            - Controller</span>
<span class="sd">            - GP aggregator</span>
<span class="sd">            - Searcher</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clear the cache and reset the compute graph</span>
        <span class="n">Program</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
                
        <span class="c1"># initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_prior</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_state_manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_controller</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp_aggregator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gp_aggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_searcher</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_seeds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="KD_DSCV.info">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print model information.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Library: &quot;</span><span class="p">,</span> <span class="n">Program</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">library</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">report_constraint_counts</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="KD_DSCV.import_inner_data">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.import_inner_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_inner_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import data from predefined datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (str): Name of dataset.</span>
<span class="sd">            data_type (str): Type of data (&#39;regular&#39; or &#39;sparse&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="o">=</span> <span class="n">RegularData</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
            
            <span class="c1"># Save file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span>
                                    <span class="s2">&quot;discover_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
                <span class="p">)</span>            
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span></div>


<div class="viewcode-block" id="KD_DSCV.import_dataset">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.import_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sym_true</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_input_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import data through a :class:`~kd.dataset.PDEDataset` instance.</span>

<span class="sd">        This keeps the legacy :meth:`import_inner_data` path untouched while</span>
<span class="sd">        allowing external callers to provide data via the unified</span>
<span class="sd">        :func:`kd.dataset.load_pde` / :class:`PDEDataset` pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: A :class:`kd.dataset.PDEDataset` instance.</span>
<span class="sd">            sym_true: Optional override for the ground-truth symbolic equation.</span>
<span class="sd">            n_input_dim: Optional override for the number of spatial input</span>
<span class="sd">                dimensions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            KD_DSCV: The estimator instance (for chaining).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">kd.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDEDataset</span>  <span class="c1"># lazy import to avoid circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.discover.adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DSCVRegularAdapter</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">PDEDataset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dataset must be a PDEDataset instance&quot;</span><span class="p">)</span>

        <span class="n">adapter</span> <span class="o">=</span> <span class="n">DSCVRegularAdapter</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sym_true</span><span class="o">=</span><span class="n">sym_true</span><span class="p">,</span> <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="o">=</span> <span class="n">adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_</span> <span class="o">=</span> <span class="n">dataset</span>

        <span class="n">resolved_name</span> <span class="o">=</span> <span class="n">dataset_name</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;legacy_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;registry_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;equation_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;custom_dataset&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">resolved_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;discover_</span><span class="si">{</span><span class="n">resolved_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="KD_DSCV.make_outter_data">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_outter_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_outter_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create data handler for external data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            x: Input features.</span>
<span class="sd">            y: Target values.</span>
<span class="sd">            domains: Domain boundaries.</span>
<span class="sd">            data_type (str): Type of data.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If data type is not &#39;regular&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="s2">&quot;only regular form of dataset is supported in current mode&quot;</span></div>

        <span class="c1"># Todo (KD 1.x): legacy path, kept only for upstream compatibility.</span>
        <span class="c1"># In KD it is recommended to use PDEDataset + import_dataset/fit_from_dataset/fit_dataset.</span>

<div class="viewcode-block" id="KD_DSCV.fit">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">domains</span><span class="o">=</span><span class="p">[],</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated external ``(X, y)`` entry point (disabled in KD 1.0).</span>

<span class="sd">        Use :meth:`import_dataset`, :meth:`fit_from_dataset` or</span>
<span class="sd">        :meth:`fit_dataset` together with :class:`kd.dataset.PDEDataset`</span>
<span class="sd">        instead of calling :meth:`fit` with raw arrays.</span>

<span class="sd">        Users who need full control over ``X``/``y``/``domains`` should refer</span>
<span class="sd">        to the native DISCOVER ``PDETask`` examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;KD_DSCV.fit(X, y, ...) is deprecated and no longer supported in KD 1.0. &quot;</span>
            <span class="s2">&quot;Please use import_dataset / fit_from_dataset / fit_dataset together &quot;</span>
            <span class="s2">&quot;with a kd.dataset.PDEDataset instance.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.fit_dataset">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.fit_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sym_true</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">n_input_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train DSCV (local PDE mode) directly from a :class:`PDEDataset`.</span>

<span class="sd">        This is a convenience wrapper aligned with :class:`KD_SGA` and</span>
<span class="sd">        :class:`KD_DLGA`, using the unified dataset-based entry point.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 真实实现路径：导入 PDEDataset 并启动 searcher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dataset</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">sym_true</span><span class="o">=</span><span class="n">sym_true</span><span class="p">,</span>
            <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">,</span>
            <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.train_one_step">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.train_one_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_one_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train model for one step.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            epoch (int): Current epoch.</span>
<span class="sd">            verbose (bool): Whether to print progress.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Training results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">search_one_step</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.train">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.train">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train model for multiple epochs.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            n_epochs (int): Number of epochs.</span>
<span class="sd">            verbose (bool): Whether to print progress.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Training results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="KD_DSCV.set_config">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.set_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set model configuration.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary or path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_config_file</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">base_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">config_update</span> <span class="o">=</span> <span class="n">safe_merge_dicts</span><span class="p">(</span><span class="n">base_config</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">config_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span>
        <span class="c1"># Snapshot original function_set for safe reset on re-import.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_function_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function_set&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prior&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_state_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;state_manager&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;controller&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_gp_agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gp_agg&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="KD_DSCV.make_prior">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_prior">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create prior for equation generation.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Prior: Prior object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span><span class="n">Program</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_prior</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prior</span></div>


<div class="viewcode-block" id="KD_DSCV.make_state_manager">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_state_manager">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_state_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create state manager.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            StateManager: State manager object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">manager_make_state_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_state_manager</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.make_controller">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_controller">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create controller.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Controller: Controller object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="p">,</span>
                                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config_controller</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">controller</span></div>


<div class="viewcode-block" id="KD_DSCV.make_gp_aggregator">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_gp_aggregator">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_gp_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create GP aggregator if enabled.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            GPAggregator or None: GP aggregator object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># KD 1.x 中禁用 GP aggregator / 多进程聚合逻辑，避免 self.pool / import 路径等历史问题。</span>
        <span class="c1"># 即使配置中设置了 run_gp_agg=True，也只给出一次性告警并返回 None。</span>
        <span class="n">run_gp_agg</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_gp_agg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_gp_agg&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">run_gp_agg</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;KD_DSCV: GP aggregator (run_gp_agg=True) 在 KD 1.x 中不受支持，将被忽略。&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="KD_DSCV.make_searcher">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.make_searcher">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_searcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create searcher.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Searcher: Searcher object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s1">&#39;n_samples_per_batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples_per_batch</span>

        <span class="n">searcher</span> <span class="o">=</span> <span class="n">Searcher</span><span class="p">(</span>
                            <span class="n">controller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">,</span>
                            <span class="n">gp_aggregator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gp_aggregator</span>
                            <span class="p">)</span>
        <span class="k">return</span> <span class="n">searcher</span></div>


    <span class="c1"># Diff tokens for each spatial dimension (used for auto function_set).</span>
    <span class="c1"># Numpy (FD) tokens — used by KD_DSCV (Regular mode).</span>
    <span class="n">_DIFF_TOKENS_BY_DIM</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;diff2&quot;</span><span class="p">,</span> <span class="s2">&quot;diff3&quot;</span><span class="p">],</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">,</span> <span class="s2">&quot;Diff2&quot;</span><span class="p">,</span> <span class="s2">&quot;lap&quot;</span><span class="p">],</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Diff_3&quot;</span><span class="p">,</span> <span class="s2">&quot;Diff2_3&quot;</span><span class="p">,</span> <span class="s2">&quot;lap_3&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># Torch (PINN) tokens — used by KD_DSCV_SPR (Sparse mode).</span>
    <span class="c1"># For N-D, lap_t provides the Laplacian via autograd (sum of d2u/dxi^2).</span>
    <span class="c1"># diff_t/diff2_t are 1D-oriented; lap_t covers the common N-D PDE pattern.</span>
    <span class="n">_DIFF_TOKENS_TORCH_BY_DIM</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;diff_t&quot;</span><span class="p">,</span> <span class="s2">&quot;diff2_t&quot;</span><span class="p">,</span> <span class="s2">&quot;diff3_t&quot;</span><span class="p">],</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;lap_t&quot;</span><span class="p">],</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;lap_t&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># All diff-family tokens across all dimensions (used to strip before replacing).</span>
    <span class="n">_ALL_DIFF_TOKENS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;diff2&quot;</span><span class="p">,</span> <span class="s2">&quot;diff3&quot;</span><span class="p">,</span> <span class="s2">&quot;diff4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Diff&quot;</span><span class="p">,</span> <span class="s2">&quot;Diff2&quot;</span><span class="p">,</span> <span class="s2">&quot;lap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Diff_3&quot;</span><span class="p">,</span> <span class="s2">&quot;Diff2_3&quot;</span><span class="p">,</span> <span class="s2">&quot;lap_3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;diff_t&quot;</span><span class="p">,</span> <span class="s2">&quot;diff2_t&quot;</span><span class="p">,</span> <span class="s2">&quot;diff3_t&quot;</span><span class="p">,</span> <span class="s2">&quot;diff4_t&quot;</span><span class="p">,</span> <span class="s2">&quot;lap_t&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="KD_DSCV.set_task">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.set_task">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set task configuration and optimizer.&quot;&quot;&quot;</span>
        <span class="c1"># Set the constant optimizer</span>
        <span class="n">const_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s2">&quot;const_optimizer&quot;</span><span class="p">]</span>
        <span class="n">const_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s2">&quot;const_params&quot;</span><span class="p">]</span>
        <span class="n">const_params</span> <span class="o">=</span> <span class="n">const_params</span> <span class="k">if</span> <span class="n">const_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">Program</span><span class="o">.</span><span class="n">set_const_optimizer</span><span class="p">(</span><span class="n">const_optimizer</span><span class="p">,</span> <span class="o">**</span><span class="n">const_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s1">&#39;function_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_select_function_set</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Dataset should be made before setting task&quot;</span>
        <span class="n">set_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_auto_select_function_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace default 1D diff tokens with dimension-appropriate ones.</span>

<span class="sd">        Only activates when the user did not specify ``operator`` and</span>
<span class="sd">        ``n_input_dim &gt; 1``.  Preserves non-diff tokens (add, mul, etc.).</span>

<span class="sd">        Always resets from ``_base_function_set`` to avoid stale tokens</span>
<span class="sd">        when the same ``KD_DSCV`` instance is reused across datasets.</span>

<span class="sd">        Handles both numpy (FD) tokens for Regular mode and torch tokens</span>
<span class="sd">        for PINN/Sparse mode, selecting the correct map based on whether</span>
<span class="sd">        the base function_set contains torch tokens (``_t`` suffix).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset to base config snapshot to avoid stale mutations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;function_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_function_set</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">n_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_input_dim&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_dim</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Detect torch mode: base function_set contains _t suffix tokens</span>
        <span class="n">has_torch</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_t&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_function_set</span><span class="p">)</span>
        <span class="n">token_map</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DIFF_TOKENS_TORCH_BY_DIM</span> <span class="k">if</span> <span class="n">has_torch</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DIFF_TOKENS_BY_DIM</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">n_dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_map</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Strip ALL diff-family tokens (across all dims) to avoid duplicates,</span>
        <span class="c1"># then inject exactly the target-dimension tokens.</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_function_set</span><span class="p">)</span>
        <span class="n">non_diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">current</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALL_DIFF_TOKENS</span><span class="p">]</span>
        <span class="n">new_diff</span> <span class="o">=</span> <span class="n">token_map</span><span class="p">[</span><span class="n">n_dim</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;function_set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">new_diff</span> <span class="o">+</span> <span class="n">non_diff</span><span class="p">))</span>

<div class="viewcode-block" id="KD_DSCV.set_seeds">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.set_seeds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_seeds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_seed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set random seeds for reproducibility.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            new_seed (int): Random seed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">new_seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">new_seed</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">new_seed</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">new_seed</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="KD_DSCV.print_pq">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.print_pq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_pq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print priority queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">print_pq</span><span class="p">()</span></div>


<div class="viewcode-block" id="KD_DSCV.plot">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot training results.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fig_type (str): Type of figure to plot.</span>
<span class="sd">            **kwargs: Additional plotting arguments.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Figure: Matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV.predict">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make predictions (not implemented).&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>


<div class="viewcode-block" id="KD_DSCV_SPR">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KD_DSCV_SPR</span><span class="p">(</span><span class="n">KD_DSCV</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;KD_DSCV model with Physics-Informed Neural Networks.</span>
<span class="sd">    </span>
<span class="sd">    This class extends KD_DSCV with PINN capabilities for better</span>
<span class="sd">    equation discovery in sparse data settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KD_DSCV_SPR.__init__">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">config_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize KD_DSCV_Pinn model.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for KD_DSCV.</span>
<span class="sd">            config_out: Optional output configuration.</span>
<span class="sd">            **kwargs: Keyword arguments for KD_DSCV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">config_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config_file</span> <span class="o">=</span> <span class="s2">&quot;./discover/config/config_pde_pinn.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_realtime</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="KD_DSCV_SPR.set_config">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.set_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set model configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary or path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pinn&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pde_pinn&#39;</span>
        <span class="c1"># Baseline values for reset when reusing instances across dimensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_pinn_input_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_dim&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_generation_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_type&quot;</span><span class="p">,</span> <span class="s2">&quot;AD&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_n_input_var</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_input_var&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="KD_DSCV_SPR.import_dataset">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.import_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">colloc_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">noise_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">spline_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cut_quantile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import sparse/PINN data via :class:`~kd.dataset.PDEDataset`.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: A :class:`kd.dataset.PDEDataset` instance.</span>
<span class="sd">            sample: Absolute number of training samples (takes precedence</span>
<span class="sd">                over ``sample_ratio`` when provided).</span>
<span class="sd">            sample_ratio: Fraction of available points to sample in ``(0, 1]``,</span>
<span class="sd">                default ``0.1``.</span>
<span class="sd">            colloc_num: Number of collocation points for PINN training; if</span>
<span class="sd">                ``None``, the default configured value is used.</span>
<span class="sd">            random_state: Random seed for reproducible sampling.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">kd.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDEDataset</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.discover.adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DSCVSparseAdapter</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">PDEDataset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dataset must be a PDEDataset instance&quot;</span><span class="p">)</span>

        <span class="n">adapter</span> <span class="o">=</span> <span class="n">DSCVSparseAdapter</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">sample_ratio</span><span class="o">=</span><span class="n">sample_ratio</span><span class="p">,</span>
            <span class="n">colloc_num</span><span class="o">=</span><span class="n">colloc_num</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">noise_level</span><span class="o">=</span><span class="n">noise_level</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">data_ratio</span><span class="o">=</span><span class="n">data_ratio</span><span class="p">,</span>
            <span class="n">spline_sample</span><span class="o">=</span><span class="n">spline_sample</span><span class="p">,</span>
            <span class="n">cut_quantile</span><span class="o">=</span><span class="n">cut_quantile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="o">=</span> <span class="n">adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_</span> <span class="o">=</span> <span class="n">dataset</span>

        <span class="c1"># Inject N-D config from adapter output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_nd_config</span><span class="p">()</span>

        <span class="n">resolved_name</span> <span class="o">=</span> <span class="n">dataset_name</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;legacy_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;registry_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;equation_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;custom_dataset&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">resolved_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;discover_</span><span class="si">{</span><span class="n">resolved_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_inject_nd_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject N-D PINN config from adapter&#39;s ``n_input_dim``.</span>

<span class="sd">        Always resets to baseline first to avoid stale config when the same</span>
<span class="sd">        instance is reused across datasets of different dimensionality.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset to baseline to handle ND→1D reuse.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s2">&quot;input_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_pinn_input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s2">&quot;generation_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_generation_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;n_input_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_n_input_var</span>
        <span class="c1"># Reset param baseline.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;n_param_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;param_names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">n_spatial</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_input_dim&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_spatial</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s2">&quot;input_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_spatial</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s2">&quot;generation_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;multi_AD&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;n_input_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_spatial</span>

        <span class="c1"># Inject param_fields config (independent of n_spatial).</span>
        <span class="n">n_param_var</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_param_var&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_param_var</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;n_param_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_param_var</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;param_names&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="KD_DSCV_SPR.make_pinn_model">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.make_pinn_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_pinn_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create PINN model.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            PINN_model: PINN model object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using device:&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">PINN_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">],</span>
            <span class="n">device</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

    
<div class="viewcode-block" id="KD_DSCV_SPR.setup">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup model components including PINN.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_pinn_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span><span class="o">.</span><span class="n">import_outter_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>   </div>

        
<div class="viewcode-block" id="KD_DSCV_SPR.reset_up">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.reset_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_controller</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">new_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset model components.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            clear_cache (bool): Whether to clear program cache.</span>
<span class="sd">            reset_controller (bool): Whether to reset controller.</span>
<span class="sd">            new_seed (int): New random seed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">clear_cache</span><span class="p">:</span>
            <span class="n">Program</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">new_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_seeds</span><span class="p">(</span><span class="n">new_seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_controller</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_controller</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="KD_DSCV_SPR.pretrain">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.pretrain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pretrain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pretrain PINN model with observations.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NN evaluator training with data&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span><span class="o">.</span><span class="n">pretrain</span><span class="p">()</span>
        <span class="n">Program</span><span class="o">.</span><span class="n">reset_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s1">&#39;generation_type&#39;</span><span class="p">])</span></div>

        
<div class="viewcode-block" id="KD_DSCV_SPR.callIterPINN">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.callIterPINN">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">callIterPINN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run iterative PINN and PDE discovery.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            n_epochs (int): Number of epochs.</span>
<span class="sd">            verbose (bool): Whether to print progress.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Training results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrain</span><span class="p">()</span>

        <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span>    
        <span class="n">last_best_p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">)</span>
        <span class="n">iter_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s2">&quot;iter_num&quot;</span><span class="p">]</span>
        <span class="n">eq_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eq_num&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iter_num</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_up</span><span class="p">(</span><span class="n">reset_controller</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">bsz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config_training</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">bsz</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The No.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> pde discovery process&quot;</span><span class="p">)</span>   
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">keep_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="n">best_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;program&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_best_p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">last_best_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">from_tokens</span><span class="p">(</span><span class="n">best_tokens</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">last_best_p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r_ridge</span> <span class="o">&gt;</span> <span class="n">best_p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r_ridge</span><span class="p">:</span>
                        <span class="n">new_best_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_best_p</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_best_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_p</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">best_p</span> <span class="o">=</span> <span class="n">new_best_p</span>
               
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">iter_num</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pinn_train</span><span class="p">(</span><span class="n">best_p</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s1">&#39;coef_pde&#39;</span><span class="p">],</span>
                            <span class="n">local_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s1">&#39;local_sample&#39;</span><span class="p">],</span>
                            <span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">)</span>
            
            <span class="n">best_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_p</span> <span class="o">=</span> <span class="n">best_p</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The No.</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2"> pde discovery process&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_up</span><span class="p">(</span><span class="n">reset_controller</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">keep_history</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="KD_DSCV_SPR.pinn_train">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.pinn_train">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pinn_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">best_p</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">local_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train PINN with discovered equation constraint.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            best_p: Best program found.</span>
<span class="sd">            count (int): Iteration count.</span>
<span class="sd">            coef (float): Coefficient for PDE constraint.</span>
<span class="sd">            local_sample (bool): Whether to use local sampling.</span>
<span class="sd">            last (bool): Whether this is the last iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span><span class="o">.</span><span class="n">train_pinn</span><span class="p">(</span><span class="n">best_p</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="n">coef</span><span class="p">,</span> <span class="n">local_sample</span><span class="o">=</span><span class="n">local_sample</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">)</span>
        <span class="n">Program</span><span class="o">.</span><span class="n">reset_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">denoise_pinn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_pinn</span><span class="p">[</span><span class="s1">&#39;generation_type&#39;</span><span class="p">])</span></div>

                
<div class="viewcode-block" id="KD_DSCV_SPR.train">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.train">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train model.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            n_epochs (int): Number of epochs.</span>
<span class="sd">            verbose (bool): Whether to print progress.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Training results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">eq_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_task</span><span class="p">[</span><span class="s1">&#39;eq_num&#39;</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">best_p</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eq_num</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callIterPINN</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="KD_DSCV_SPR.make_outter_data">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.make_outter_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_outter_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create data handler for external data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            x: Input features.</span>
<span class="sd">            y: Target values.</span>
<span class="sd">            domains: Domain boundaries.</span>
<span class="sd">            data_type (str): Type of data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="o">=</span> <span class="n">SparseData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>    </div>


<div class="viewcode-block" id="KD_DSCV_SPR.fit">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;Sparse&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model to data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            x: Input features.</span>
<span class="sd">            y: Target values.</span>
<span class="sd">            domains: Domain boundaries.</span>
<span class="sd">            n_epochs (int): Number of epochs.</span>
<span class="sd">            verbose (bool): Whether to print progress.</span>
<span class="sd">            data_type (str): Type of data.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Training results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_outter_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="KD_DSCV_SPR.predict">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make predictions (not implemented).&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="KD_DSCV_SPR.fit_dataset">
<a class="viewcode-back" href="../../../api.html#kd.model.kd_dscv.KD_DSCV_SPR.fit_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">colloc_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
        <span class="n">noise_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">spline_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cut_quantile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience wrapper for Sparse+PINN training from :class:`PDEDataset`.</span>

<span class="sd">        This mirrors the style of the local PDE ``fit_dataset`` entry point</span>
<span class="sd">        while targeting the sparse/PINN DISCOVER task.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">import_dataset</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">sample_ratio</span><span class="o">=</span><span class="n">sample_ratio</span><span class="p">,</span>
            <span class="n">colloc_num</span><span class="o">=</span><span class="n">colloc_num</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">noise_level</span><span class="o">=</span><span class="n">noise_level</span><span class="p">,</span>
            <span class="n">data_ratio</span><span class="o">=</span><span class="n">data_ratio</span><span class="p">,</span>
            <span class="n">spline_sample</span><span class="o">=</span><span class="n">spline_sample</span><span class="p">,</span>
            <span class="n">cut_quantile</span><span class="o">=</span><span class="n">cut_quantile</span><span class="p">,</span>
            <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025-2026, Scientific-Artificial-Intelligence-Lab.
      
    </div>

    
    <a href="https://github.com/Scientific-Artificial-Intelligence-Lab/kd" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>